generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

// ============================================
// AUTHENTIFICATION & UTILISATEURS
// ============================================

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  createdDonors  Donor[]    @relation("CreatedBy")
  updatedDonors  Donor[]    @relation("UpdatedBy")
  donations      Donation[] @relation("RecordedBy")
}

enum UserRole {
  ADMIN
  MANAGER
  ANALYST
  VIEWER
  USER
}

// ============================================
// MODULE BASE DONATEURS
// ============================================

model Donor {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations personnelles
  firstName   String
  lastName    String
  email       String?  @unique
  phone       String?
  mobile      String?
  dateOfBirth DateTime?

  // Adresse
  address     String?
  address2    String?
  city        String?
  state       String?
  postalCode  String?
  country     String?  @default("Canada")

  // Données professionnelles
  profession  String?
  employer    String?
  jobTitle    String?
  industry    String?

  // Statut et classification
  status      DonorStatus @default(ACTIVE)
  donorType   DonorType   @default(INDIVIDUAL)
  segment     String?
  tags        String[]

  // Métriques calculées (dénormalisées pour performance)
  totalDonations    Float    @default(0)
  donationCount     Int      @default(0)
  averageDonation   Float    @default(0)
  highestDonation   Float    @default(0)
  lastDonationDate  DateTime?
  firstDonationDate DateTime?

  // Notes et commentaires
  notes       String?
  source      String?  // Comment le donateur a été acquis

  // Conformité RGPD/PIPEDA
  consentEmail     Boolean @default(false)
  consentPhone     Boolean @default(false)
  consentMail      Boolean @default(false)
  consentDate      DateTime?
  optOutDate       DateTime?

  // Audit
  createdById Int?
  createdBy   User? @relation("CreatedBy", fields: [createdById], references: [id])
  updatedById Int?
  updatedBy   User? @relation("UpdatedBy", fields: [updatedById], references: [id])

  // Relations
  donations       Donation[]
  preferences     DonorPreference?
  customFields    DonorCustomField[]
  communications  Communication[]
  submissions     DonationSubmission[]
  consentHistory  ConsentHistory[]
  taxReceipts     TaxReceipt[]

  @@index([email])
  @@index([lastName, firstName])
  @@index([status])
  @@index([segment])
  @@index([createdAt])
  @@index([totalDonations])
}

enum DonorStatus {
  ACTIVE
  INACTIVE
  LAPSED
  DECEASED
  DO_NOT_CONTACT
  PENDING
}

enum DonorType {
  INDIVIDUAL
  CORPORATE
  FOUNDATION
  GOVERNMENT
  ANONYMOUS
}

// ============================================
// HISTORIQUE DES DONS
// ============================================

model Donation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations du don
  amount        Float
  currency      String    @default("CAD")
  donationDate  DateTime
  paymentMethod PaymentMethod
  status        DonationStatus @default(COMPLETED)

  // Référence
  transactionId   String?   @unique
  receiptNumber   String?
  receiptSentAt   DateTime?

  // Campagne associée
  campaignId    String?
  campaignName  String?

  // Type de don
  donationType  DonationType @default(ONE_TIME)
  isRecurring   Boolean      @default(false)
  recurringId   String?

  // Don dédié (in memoriam, en l'honneur de)
  dedicationType  DedicationType?
  dedicateeName   String?
  dedicateeEmail  String?
  notifyDedicatee Boolean @default(false)

  // Notes
  notes         String?
  isAnonymous   Boolean @default(false)

  // Relations
  donorId     String
  donor       Donor  @relation(fields: [donorId], references: [id], onDelete: Cascade)
  recordedById Int?
  recordedBy   User?  @relation("RecordedBy", fields: [recordedById], references: [id])
  taxReceipts  TaxReceipt[]

  @@index([donorId])
  @@index([donationDate])
  @@index([campaignId])
  @@index([status])
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT
  BANK_TRANSFER
  CHECK
  CASH
  PAYPAL
  OTHER
}

enum DonationStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum DonationType {
  ONE_TIME
  MONTHLY
  QUARTERLY
  ANNUAL
  PLEDGE
}

enum DedicationType {
  IN_MEMORY
  IN_HONOR
  TRIBUTE
}

// ============================================
// PRÉFÉRENCES DONATEUR
// ============================================

model DonorPreference {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Canaux de communication préférés
  preferredChannel    CommunicationChannel @default(EMAIL)
  preferredFrequency  CommunicationFrequency @default(MONTHLY)
  preferredLanguage   String @default("fr")

  // Causes d'intérêt
  causesOfInterest    String[]

  // Préférences de don
  preferredAmount     Float?
  preferredPaymentMethod PaymentMethod?

  // Dates importantes
  birthday            DateTime?
  anniversary         DateTime?

  // Relation
  donorId String @unique
  donor   Donor  @relation(fields: [donorId], references: [id], onDelete: Cascade)
}

enum CommunicationChannel {
  EMAIL
  PHONE
  SMS
  MAIL
  SOCIAL_MEDIA
}

enum CommunicationFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  NEVER
}

// ============================================
// CHAMPS PERSONNALISÉS
// ============================================

model CustomFieldDefinition {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String   @unique
  label       String
  fieldType   FieldType
  options     String[] // Pour les champs SELECT/MULTISELECT
  isRequired  Boolean  @default(false)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  // Valeurs
  values DonorCustomField[]
}

model DonorCustomField {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  value     String

  // Relations
  donorId   String
  donor     Donor @relation(fields: [donorId], references: [id], onDelete: Cascade)
  fieldId   String
  field     CustomFieldDefinition @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([donorId, fieldId])
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  BOOLEAN
  SELECT
  MULTISELECT
  URL
  EMAIL
  PHONE
}

// ============================================
// COMMUNICATIONS
// ============================================

model Communication {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  type      CommunicationType
  channel   CommunicationChannel
  subject   String?
  content   String?
  sentAt    DateTime?
  status    CommunicationStatus @default(PENDING)

  // Métriques
  openedAt    DateTime?
  clickedAt   DateTime?
  bouncedAt   DateTime?

  // Relation
  donorId String
  donor   Donor  @relation(fields: [donorId], references: [id], onDelete: Cascade)

  @@index([donorId])
  @@index([sentAt])
  @@index([type])
}

enum CommunicationType {
  THANK_YOU
  RECEIPT
  NEWSLETTER
  APPEAL
  EVENT_INVITATION
  SURVEY
  REMINDER
  OTHER
}

enum CommunicationStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}


// ============================================
// MODULE FORMULAIRES DON
// ============================================

model DonationForm {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations générales
  name          String
  slug          String   @unique
  description   String?
  formType      FormType @default(ONE_TIME)
  status        FormStatus @default(DRAFT)

  // Configuration des montants
  suggestedAmounts    Int[]    @default([25, 50, 100, 250, 500])
  minimumAmount       Float    @default(5)
  maximumAmount       Float?
  allowCustomAmount   Boolean  @default(true)
  defaultAmount       Float?

  // Configuration récurrence (pour dons récurrents)
  recurringOptions    RecurringFrequency[] @default([MONTHLY])
  defaultRecurring    RecurringFrequency?

  // Personnalisation visuelle
  primaryColor        String   @default("#6366f1")
  secondaryColor      String   @default("#8b5cf6")
  logoUrl             String?
  bannerUrl           String?
  thankYouMessage     String?
  thankYouRedirectUrl String?

  // Configuration des champs
  collectPhone        Boolean  @default(false)
  collectAddress      Boolean  @default(false)
  collectEmployer     Boolean  @default(false)
  collectComment      Boolean  @default(true)
  collectDedication   Boolean  @default(false)
  allowAnonymous      Boolean  @default(true)

  // SEO et partage
  metaTitle           String?
  metaDescription     String?
  ogImage             String?

  // Campagne associée
  campaignId          String?
  campaignName        String?

  // Statistiques (dénormalisées)
  totalCollected      Float    @default(0)
  donationCount       Int      @default(0)
  averageDonation     Float    @default(0)

  // Dates de validité
  startDate           DateTime?
  endDate             DateTime?
  goalAmount          Float?

  // Relations
  fields              FormField[]
  submissions         DonationSubmission[]

  @@index([slug])
  @@index([status])
  @@index([formType])
  @@index([createdAt])
}

enum FormType {
  ONE_TIME        // Don unique
  RECURRING       // Don récurrent
  TICKETING       // Billetterie événement
  IN_MEMORIAM     // Don in memoriam
  PEER_TO_PEER    // Collecte P2P
  PLEDGE          // Promesse de don
}

enum FormStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  SCHEDULED
}

enum RecurringFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model FormField {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Configuration du champ
  name          String
  label         String
  fieldType     FormFieldType
  placeholder   String?
  helpText      String?
  defaultValue  String?
  options       String[]  // Pour SELECT/RADIO/CHECKBOX
  
  // Validation
  isRequired    Boolean   @default(false)
  minLength     Int?
  maxLength     Int?
  pattern       String?   // Regex pour validation
  
  // Affichage
  sortOrder     Int       @default(0)
  isVisible     Boolean   @default(true)
  width         FieldWidth @default(FULL)
  
  // Logique conditionnelle
  showIf        String?   // JSON condition

  // Relation
  formId        String
  form          DonationForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([sortOrder])
}

enum FormFieldType {
  TEXT
  EMAIL
  PHONE
  NUMBER
  TEXTAREA
  SELECT
  RADIO
  CHECKBOX
  DATE
  HIDDEN
}

enum FieldWidth {
  FULL
  HALF
  THIRD
}

model DonationSubmission {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations du don
  amount            Float
  currency          String    @default("CAD")
  paymentMethod     PaymentMethod?
  paymentStatus     PaymentStatus @default(PENDING)
  
  // Référence paiement
  stripePaymentId   String?
  stripeCustomerId  String?
  transactionId     String?   @unique

  // Informations donateur
  email             String
  firstName         String
  lastName          String
  phone             String?
  address           String?
  city              String?
  state             String?
  postalCode        String?
  country           String?   @default("Canada")
  
  // Employeur (pour matching gifts)
  employer          String?
  
  // Don récurrent
  isRecurring       Boolean   @default(false)
  recurringFrequency RecurringFrequency?
  nextPaymentDate   DateTime?
  recurringStatus   RecurringStatus?

  // Dédicace (in memoriam)
  dedicationType    DedicationType?
  dedicateeName     String?
  dedicateeEmail    String?
  dedicateeMessage  String?
  notifyDedicatee   Boolean   @default(false)

  // Options
  isAnonymous       Boolean   @default(false)
  comment           String?
  
  // Consentements
  consentEmail      Boolean   @default(false)
  consentNewsletter Boolean   @default(false)
  
  // Données personnalisées (JSON)
  customFields      String?   // JSON des champs personnalisés
  
  // Reçu fiscal
  receiptNumber     String?
  receiptSentAt     DateTime?
  
  // Tracking
  source            String?   // UTM source
  medium            String?   // UTM medium
  campaign          String?   // UTM campaign
  referrer          String?
  ipAddress         String?
  userAgent         String?

  // Relations
  formId            String
  form              DonationForm @relation(fields: [formId], references: [id])
  donorId           String?
  donor             Donor?    @relation(fields: [donorId], references: [id])

  @@index([formId])
  @@index([donorId])
  @@index([email])
  @@index([createdAt])
  @@index([paymentStatus])
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum RecurringStatus {
  ACTIVE
  PAUSED
  CANCELLED
  FAILED
  COMPLETED
}

// Ajout de la relation dans Donor
// (déjà géré par la relation DonationSubmission.donor)


// ============================================
// MODULE GESTION CAMPAGNES
// ============================================

model Campaign {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations générales
  name          String
  slug          String   @unique
  description   String?
  shortDescription String?
  
  // Type et statut
  campaignType  CampaignType @default(FUNDRAISING)
  status        CampaignStatus @default(DRAFT)
  priority      CampaignPriority @default(MEDIUM)

  // Dates
  startDate     DateTime?
  endDate       DateTime?
  launchDate    DateTime?

  // Objectifs financiers
  goalAmount    Float?
  minimumGoal   Float?
  stretchGoal   Float?

  // Statistiques (dénormalisées)
  totalRaised       Float    @default(0)
  donationCount     Int      @default(0)
  donorCount        Int      @default(0)
  averageDonation   Float    @default(0)
  largestDonation   Float    @default(0)
  conversionRate    Float    @default(0)

  // Personnalisation visuelle
  primaryColor      String   @default("#6366f1")
  secondaryColor    String   @default("#8b5cf6")
  logoUrl           String?
  bannerUrl         String?
  thumbnailUrl      String?

  // Contenu
  thankYouMessage   String?
  impactStatement   String?

  // SEO
  metaTitle         String?
  metaDescription   String?
  ogImage           String?

  // Configuration
  isPublic          Boolean  @default(true)
  allowP2P          Boolean  @default(false)
  enableMatching    Boolean  @default(false)
  matchingRatio     Float?   // Ex: 2.0 = 2:1 matching
  matchingCap       Float?

  // Catégorie/Tags
  category          String?
  tags              String[]

  // Relations
  milestones        CampaignMilestone[]
  donors            CampaignDonor[]
  forms             CampaignForm[]
  updates           CampaignUpdate[]
  team              CampaignTeamMember[]
  p2pFundraisers    P2PFundraiser[]

  @@index([slug])
  @@index([status])
  @@index([campaignType])
  @@index([startDate])
  @@index([endDate])
}

enum CampaignType {
  FUNDRAISING       // Collecte générale
  ANNUAL_FUND       // Campagne annuelle
  CAPITAL           // Campagne de capital
  EMERGENCY         // Urgence/Crise
  EVENT             // Événement
  PEER_TO_PEER      // P2P
  CROWDFUNDING      // Financement participatif
  MATCHING          // Campagne avec matching
  PLANNED_GIVING    // Dons planifiés
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
  ARCHIVED
}

enum CampaignPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Jalons de campagne
model CampaignMilestone {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations
  title         String
  description   String?
  targetAmount  Float?
  targetDate    DateTime?
  
  // Statut
  isCompleted   Boolean   @default(false)
  completedAt   DateTime?
  actualAmount  Float?

  // Affichage
  sortOrder     Int       @default(0)
  icon          String?
  color         String?

  // Relation
  campaignId    String
  campaign      Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([sortOrder])
}

// Relation Campagne-Donateur
model CampaignDonor {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Montants
  totalDonated      Float    @default(0)
  donationCount     Int      @default(0)
  firstDonationDate DateTime?
  lastDonationDate  DateTime?
  largestDonation   Float    @default(0)

  // Statut dans la campagne
  donorLevel        DonorLevel @default(SUPPORTER)
  isRecurring       Boolean    @default(false)
  isMajorDonor      Boolean    @default(false)

  // Notes spécifiques à la campagne
  notes             String?

  // Relations
  campaignId        String
  campaign          Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  donorId           String

  @@unique([campaignId, donorId])
  @@index([campaignId])
  @@index([donorId])
  @@index([totalDonated])
}

enum DonorLevel {
  SUPPORTER
  CONTRIBUTOR
  PATRON
  BENEFACTOR
  CHAMPION
  VISIONARY
}

// Formulaires associés à une campagne
model CampaignForm {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  campaignId    String
  campaign      Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  formId        String

  // Configuration
  isPrimary     Boolean  @default(false)

  @@unique([campaignId, formId])
  @@index([campaignId])
}

// Mises à jour de campagne
model CampaignUpdate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Contenu
  title         String
  content       String
  imageUrl      String?
  videoUrl      String?

  // Publication
  isPublished   Boolean   @default(false)
  publishedAt   DateTime?

  // Statistiques
  viewCount     Int       @default(0)
  shareCount    Int       @default(0)

  // Relation
  campaignId    String
  campaign      Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([publishedAt])
}

// Équipe de campagne
model CampaignTeamMember {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Informations
  name          String
  role          String?
  email         String?
  phone         String?
  photoUrl      String?
  bio           String?

  // Objectifs personnels (pour P2P)
  personalGoal      Float?
  totalRaised       Float    @default(0)
  donorCount        Int      @default(0)

  // Affichage
  sortOrder     Int       @default(0)
  isVisible     Boolean   @default(true)

  // Relation
  campaignId    String
  campaign      Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}


// ============================================
// MODULE MARKETING AUTOMATION
// ============================================

// Templates d'emails réutilisables
model EmailTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations générales
  name          String
  description   String?
  category      EmailCategory @default(GENERAL)
  
  // Contenu
  subject       String?
  preheader     String?       // Texte de prévisualisation
  htmlContent   String?       @db.Text
  textContent   String?       @db.Text  // Version texte brut
  
  // Éditeur drag & drop
  blocks        Json?         // Structure JSON des blocs de l'éditeur
  globalStyle   Json?         // Styles globaux (backgroundColor, fontFamily, contentWidth)
  thumbnail     String?       // URL de la miniature
  
  // Variables disponibles
  variables     String[]      // Ex: ["firstName", "lastName", "donationAmount"]
  
  // Design
  primaryColor  String        @default("#6366f1")
  logoUrl       String?
  footerText    String?
  
  // Statut
  isActive      Boolean       @default(true)
  isDefault     Boolean       @default(false)
  
  // Relations
  campaigns     EmailCampaign[]

  @@index([category])
  @@index([isActive])
}

enum EmailCategory {
  GENERAL
  THANK_YOU
  RECEIPT
  NEWSLETTER
  APPEAL
  EVENT
  REMINDER
  WELCOME
  BIRTHDAY
  ANNIVERSARY
  REACTIVATION
}

// Campagnes email
model EmailCampaign {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations générales
  name          String
  description   String?
  campaignType  EmailCampaignType @default(ONE_TIME)
  status        EmailCampaignStatus @default(DRAFT)
  
  // Contenu (peut surcharger le template)
  subject       String?
  preheader     String?
  htmlContent   String?       @db.Text
  
  // Segmentation des destinataires
  segmentRules  Json?         // Règles de segmentation JSON
  tags          String[]      // Tags pour filtrer les donateurs
  segments      String[]      // Segments de donateurs
  
  // Planification
  scheduledAt   DateTime?
  sentAt        DateTime?
  completedAt   DateTime?
  
  // Configuration
  fromName      String        @default("Nucleus Cause")
  fromEmail     String        @default("noreply@nucleuscause.com")
  replyTo       String?
  
  // A/B Testing
  isABTest      Boolean       @default(false)
  variantA      Json?         // Configuration variante A
  variantB      Json?         // Configuration variante B
  winningVariant String?
  
  // Statistiques
  totalRecipients   Int       @default(0)
  sentCount         Int       @default(0)
  deliveredCount    Int       @default(0)
  openCount         Int       @default(0)
  clickCount        Int       @default(0)
  bounceCount       Int       @default(0)
  unsubscribeCount  Int       @default(0)
  complaintCount    Int       @default(0)
  
  // Métriques calculées
  openRate          Float     @default(0)
  clickRate         Float     @default(0)
  bounceRate        Float     @default(0)
  
  // Relations
  templateId    String?
  template      EmailTemplate? @relation(fields: [templateId], references: [id])
  recipients    EmailRecipient[]
  automationId  String?
  automation    AutomationRule? @relation(fields: [automationId], references: [id])

  @@index([status])
  @@index([campaignType])
  @@index([scheduledAt])
  @@index([sentAt])
}

enum EmailCampaignType {
  ONE_TIME      // Envoi unique
  RECURRING     // Envoi récurrent
  AUTOMATED     // Déclenché par automation
  TRANSACTIONAL // Email transactionnel
}

enum EmailCampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
  FAILED
}

// Destinataires d'une campagne email
model EmailRecipient {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations du destinataire
  email         String
  firstName     String?
  lastName      String?
  
  // Statut d'envoi
  status        EmailRecipientStatus @default(PENDING)
  sentAt        DateTime?
  deliveredAt   DateTime?
  
  // Engagement
  openedAt      DateTime?
  openCount     Int       @default(0)
  clickedAt     DateTime?
  clickCount    Int       @default(0)
  clickedLinks  String[]
  
  // Problèmes
  bouncedAt     DateTime?
  bounceType    BounceType?
  bounceReason  String?
  unsubscribedAt DateTime?
  complainedAt  DateTime?
  
  // Variante A/B
  variant       String?   // "A" ou "B"
  
  // Relation avec donateur (optionnel)
  donorId       String?
  
  // Relation
  campaignId    String
  campaign      EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  // Relation avec les événements
  events        EmailEvent[]

  @@unique([campaignId, email])
  @@index([campaignId])
  @@index([status])
  @@index([email])
}

enum EmailRecipientStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  UNSUBSCRIBED
  COMPLAINED
  FAILED
}

enum BounceType {
  HARD
  SOFT
  TRANSIENT
}

// Règles d'automatisation
model AutomationRule {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations générales
  name          String
  description   String?
  isActive      Boolean       @default(false)
  
  // Déclencheur
  triggerType   AutomationTrigger
  triggerConfig Json?         // Configuration spécifique au trigger
  
  // Conditions
  conditions    Json?         // Conditions additionnelles
  
  // Actions
  actionType    AutomationAction
  actionConfig  Json?         // Configuration de l'action
  
  // Délai
  delayMinutes  Int           @default(0)
  delayType     DelayType     @default(IMMEDIATE)
  
  // Limites
  maxExecutions Int?          // Limite d'exécutions par donateur
  cooldownHours Int?          // Délai entre exécutions
  
  // Statistiques
  executionCount    Int       @default(0)
  lastExecutedAt    DateTime?
  successCount      Int       @default(0)
  failureCount      Int       @default(0)
  
  // Relations
  campaigns     EmailCampaign[]

  @@index([triggerType])
  @@index([isActive])
}

enum AutomationTrigger {
  // Événements donateur
  NEW_DONOR           // Nouveau donateur créé
  FIRST_DONATION      // Premier don
  DONATION_RECEIVED   // Don reçu
  RECURRING_STARTED   // Début don récurrent
  RECURRING_CANCELLED // Annulation don récurrent
  
  // Anniversaires
  BIRTHDAY            // Anniversaire du donateur
  DONATION_ANNIVERSARY // Anniversaire du premier don
  MEMBERSHIP_ANNIVERSARY // Anniversaire d'adhésion
  
  // Engagement
  INACTIVE_30_DAYS    // Inactif depuis 30 jours
  INACTIVE_90_DAYS    // Inactif depuis 90 jours
  INACTIVE_365_DAYS   // Inactif depuis 1 an
  
  // Formulaires
  FORM_SUBMITTED      // Formulaire soumis
  FORM_ABANDONED      // Formulaire abandonné
  
  // Campagnes
  CAMPAIGN_STARTED    // Campagne démarrée
  CAMPAIGN_ENDING     // Campagne se termine bientôt
  CAMPAIGN_GOAL_REACHED // Objectif atteint
  
  // Manuel
  MANUAL              // Déclenché manuellement
  SCHEDULED           // Planifié (date/heure)
}

enum AutomationAction {
  SEND_EMAIL          // Envoyer un email
  SEND_SMS            // Envoyer un SMS
  ADD_TAG             // Ajouter un tag
  REMOVE_TAG          // Retirer un tag
  UPDATE_SEGMENT      // Mettre à jour le segment
  CREATE_TASK         // Créer une tâche
  NOTIFY_TEAM         // Notifier l'équipe
  WEBHOOK             // Appeler un webhook
}

enum DelayType {
  IMMEDIATE           // Immédiat
  MINUTES             // Après X minutes
  HOURS               // Après X heures
  DAYS                // Après X jours
  SPECIFIC_TIME       // À une heure précise
}

// Journal des exécutions d'automatisation
model AutomationLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Référence à la règle
  automationId  String
  automationName String
  
  // Donateur concerné
  donorId       String?
  donorEmail    String?
  
  // Résultat
  status        AutomationLogStatus
  errorMessage  String?
  
  // Détails
  triggerData   Json?         // Données du déclencheur
  actionResult  Json?         // Résultat de l'action

  @@index([automationId])
  @@index([donorId])
  @@index([createdAt])
  @@index([status])
}

enum AutomationLogStatus {
  SUCCESS
  FAILED
  SKIPPED
  PENDING
}

// Listes de diffusion
model MailingList {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations
  name          String
  description   String?
  
  // Configuration
  isPublic      Boolean       @default(false)  // Visible pour inscription
  isDoubleOptIn Boolean       @default(true)   // Double opt-in requis
  
  // Statistiques
  subscriberCount   Int       @default(0)
  activeCount       Int       @default(0)
  
  // Relations
  subscribers   MailingListSubscriber[]

  @@index([isPublic])
}

model MailingListSubscriber {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations
  email         String
  firstName     String?
  lastName      String?
  
  // Statut
  status        SubscriberStatus @default(PENDING)
  confirmedAt   DateTime?
  unsubscribedAt DateTime?
  
  // Source
  source        String?       // Comment ils se sont inscrits
  
  // Relation avec donateur
  donorId       String?
  
  // Relation
  listId        String
  list          MailingList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([listId, email])
  @@index([listId])
  @@index([email])
  @@index([status])
}

enum SubscriberStatus {
  PENDING       // En attente de confirmation
  ACTIVE        // Actif
  UNSUBSCRIBED  // Désabonné
  BOUNCED       // Email invalide
  COMPLAINED    // A signalé comme spam
}


// ============================================
// MODULE CAMPAGNES P2P (PEER-TO-PEER)
// ============================================

// Page de collecte individuelle créée par un fundraiser
model P2PFundraiser {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations du fundraiser
  firstName     String
  lastName      String
  email         String
  phone         String?
  photoUrl      String?
  
  // Page de collecte
  slug          String   @unique
  title         String
  story         String?  @db.Text  // Histoire personnelle
  videoUrl      String?
  
  // Objectifs
  goalAmount    Float    @default(500)
  
  // Statistiques (dénormalisées)
  totalRaised       Float    @default(0)
  donationCount     Int      @default(0)
  donorCount        Int      @default(0)
  averageDonation   Float    @default(0)
  
  // Statut
  status        P2PStatus @default(PENDING)
  approvedAt    DateTime?
  publishedAt   DateTime?
  
  // Personnalisation
  primaryColor  String   @default("#6366f1")
  coverImageUrl String?
  
  // Gamification
  points        Int      @default(0)
  level         Int      @default(1)
  badges        String[] // IDs des badges obtenus
  
  // Partage social
  shareCount    Int      @default(0)
  viewCount     Int      @default(0)
  
  // Relations
  campaignId    String
  campaign      Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  teamId        String?
  team          P2PTeam? @relation(fields: [teamId], references: [id])
  donations     P2PDonation[]
  activities    P2PActivity[]
  
  // Relation optionnelle avec un donateur existant
  donorId       String?

  @@index([campaignId])
  @@index([teamId])
  @@index([slug])
  @@index([status])
  @@index([totalRaised])
}

enum P2PStatus {
  PENDING     // En attente d'approbation
  APPROVED    // Approuvé mais pas encore publié
  ACTIVE      // Actif et visible
  PAUSED      // Mis en pause
  COMPLETED   // Objectif atteint ou campagne terminée
  CANCELLED   // Annulé
}

// Équipe P2P (plusieurs fundraisers ensemble)
model P2PTeam {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations
  name          String
  slug          String   @unique
  description   String?  @db.Text
  logoUrl       String?
  coverImageUrl String?
  
  // Objectifs
  goalAmount    Float    @default(2000)
  
  // Statistiques (dénormalisées)
  totalRaised       Float    @default(0)
  donationCount     Int      @default(0)
  memberCount       Int      @default(0)
  
  // Statut
  status        P2PStatus @default(PENDING)
  
  // Gamification
  points        Int      @default(0)
  rank          Int?     // Classement parmi les équipes
  
  // Relations
  campaignId    String
  members       P2PFundraiser[]
  captainId     String?  // ID du fundraiser capitaine

  @@index([campaignId])
  @@index([slug])
  @@index([totalRaised])
}

// Dons effectués via une page P2P
model P2PDonation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Informations du don
  amount        Float
  currency      String   @default("CAD")
  
  // Donateur
  donorName     String?
  donorEmail    String
  isAnonymous   Boolean  @default(false)
  message       String?  // Message de soutien
  
  // Statut
  status        PaymentStatus @default(PENDING)
  transactionId String?  @unique
  
  // Relations
  fundraiserId  String
  fundraiser    P2PFundraiser @relation(fields: [fundraiserId], references: [id], onDelete: Cascade)
  
  // Relation optionnelle avec donateur existant
  donorId       String?

  @@index([fundraiserId])
  @@index([donorEmail])
  @@index([createdAt])
}

// Activités et événements P2P (pour le fil d'actualité)
model P2PActivity {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Type d'activité
  activityType  P2PActivityType
  
  // Contenu
  title         String
  description   String?
  imageUrl      String?
  
  // Données associées (JSON)
  metadata      Json?
  
  // Visibilité
  isPublic      Boolean  @default(true)
  
  // Relations
  fundraiserId  String
  fundraiser    P2PFundraiser @relation(fields: [fundraiserId], references: [id], onDelete: Cascade)

  @@index([fundraiserId])
  @@index([activityType])
  @@index([createdAt])
}

enum P2PActivityType {
  PAGE_CREATED      // Page créée
  DONATION_RECEIVED // Don reçu
  GOAL_REACHED      // Objectif atteint
  MILESTONE_REACHED // Jalon atteint (25%, 50%, 75%)
  BADGE_EARNED      // Badge obtenu
  SHARE_SOCIAL      // Partage sur réseaux sociaux
  UPDATE_POSTED     // Mise à jour publiée
  TEAM_JOINED       // A rejoint une équipe
}

// Badges et récompenses
model P2PBadge {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Informations
  name          String
  description   String
  iconUrl       String?
  color         String   @default("#6366f1")
  
  // Conditions d'obtention
  badgeType     P2PBadgeType
  threshold     Float?   // Seuil pour obtenir le badge
  
  // Points accordés
  pointsAwarded Int      @default(10)
  
  // Affichage
  sortOrder     Int      @default(0)
  isActive      Boolean  @default(true)

  @@index([badgeType])
}

enum P2PBadgeType {
  FIRST_DONATION      // Premier don reçu
  AMOUNT_RAISED       // Montant collecté (100$, 500$, 1000$, etc.)
  DONOR_COUNT         // Nombre de donateurs (5, 10, 25, etc.)
  GOAL_PERCENT        // Pourcentage de l'objectif (25%, 50%, 100%, 150%)
  SOCIAL_SHARE        // Partages sociaux
  STREAK              // Dons consécutifs (jours)
  TOP_FUNDRAISER      // Meilleur collecteur
  TEAM_PLAYER         // Membre d'équipe actif
  EARLY_BIRD          // Inscription rapide
  STORY_TELLER        // A partagé son histoire
}

// Classement P2P (leaderboard)
model P2PLeaderboard {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Période
  periodType    LeaderboardPeriod
  periodStart   DateTime
  periodEnd     DateTime
  
  // Type de classement
  leaderboardType LeaderboardType
  
  // Campagne associée
  campaignId    String
  
  // Données du classement (JSON array)
  rankings      Json     // [{fundraiserId, rank, amount, donorCount}]
  
  // Statut
  isFinal       Boolean  @default(false)

  @@index([campaignId])
  @@index([periodType])
  @@index([leaderboardType])
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

enum LeaderboardType {
  AMOUNT_RAISED     // Par montant collecté
  DONOR_COUNT       // Par nombre de donateurs
  POINTS            // Par points de gamification
  TEAM              // Classement des équipes
}


// ============================================
// MODULE ADMINISTRATION
// ============================================

model Permission {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Identifiant unique de la permission
  code        String   @unique  // ex: "donors.create", "campaigns.delete"
  name        String             // ex: "Créer des donateurs"
  description String?
  
  // Catégorie/Module
  module      String             // ex: "donors", "campaigns", "analytics"
  
  // Relations
  rolePermissions RolePermission[]

  @@index([module])
  @@index([code])
}

model Role {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  name        String   @unique  // ex: "Administrateur", "Gestionnaire"
  description String?
  isSystem    Boolean  @default(false)  // Rôles système non modifiables
  isActive    Boolean  @default(true)
  
  // Couleur pour l'UI
  color       String?  @default("#6366f1")
  
  // Relations
  permissions RolePermission[]
  userRoles   UserRoleAssignment[]

  @@index([name])
  @@index([isActive])
}

model RolePermission {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())

  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserRoleAssignment {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId      Int
  roleId      String
  role        Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  // Dates de validité (optionnel)
  startDate   DateTime?
  endDate     DateTime?
  
  // Qui a assigné ce rôle
  assignedBy  Int?

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model AuditLog {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())

  // Qui a fait l'action
  userId      Int?
  userName    String?
  userEmail   String?
  
  // Quelle action
  action      AuditAction
  module      String        // ex: "donors", "campaigns"
  entityType  String        // ex: "Donor", "Campaign"
  entityId    String?
  
  // Détails de l'action
  description String
  oldValue    String?       // JSON des anciennes valeurs
  newValue    String?       // JSON des nouvelles valeurs
  
  // Contexte
  ipAddress   String?
  userAgent   String?
  
  // Métadonnées
  metadata    String?       // JSON pour données additionnelles

  @@index([userId])
  @@index([action])
  @@index([module])
  @@index([entityType])
  @@index([createdAt])
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
  SEND_EMAIL
  PERMISSION_CHANGE
  SETTINGS_CHANGE
}

model SystemSetting {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Clé unique du paramètre
  key         String   @unique  // ex: "org.name", "email.sender"
  value       String             // Valeur (peut être JSON)
  
  // Métadonnées
  category    String             // ex: "organization", "email", "security"
  label       String             // Label pour l'UI
  description String?
  dataType    SettingDataType    // Type de données
  
  // Validation
  isRequired  Boolean  @default(false)
  options     String?  // JSON pour les options (select)
  
  // Sécurité
  isSecret    Boolean  @default(false)  // Masquer la valeur
  isReadOnly  Boolean  @default(false)  // Non modifiable via UI

  @@index([category])
  @@index([key])
}

enum SettingDataType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  EMAIL
  URL
  COLOR
  SELECT
}

model Integration {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Identifiant de l'intégration
  provider    String   @unique  // ex: "stripe", "mailchimp", "salesforce"
  name        String             // ex: "Stripe Payments"
  description String?
  category    IntegrationCategory
  
  // État
  isEnabled   Boolean  @default(false)
  isConfigured Boolean @default(false)
  
  // Configuration (chiffré en production)
  config      String?  // JSON des paramètres
  
  // Dernière synchronisation
  lastSyncAt  DateTime?
  lastSyncStatus String?
  
  // Métadonnées
  logoUrl     String?
  docsUrl     String?
  webhookUrl  String?

  @@index([provider])
  @@index([category])
  @@index([isEnabled])
}

enum IntegrationCategory {
  PAYMENT
  EMAIL
  CRM
  ACCOUNTING
  SOCIAL
  ANALYTICS
  OTHER
}

model Invitation {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  expiresAt   DateTime

  email       String
  roleId      String
  
  // Token unique pour l'invitation
  token       String   @unique
  
  // État
  status      InvitationStatus @default(PENDING)
  acceptedAt  DateTime?
  
  // Qui a envoyé l'invitation
  invitedBy   Int
  invitedByName String?

  @@index([email])
  @@index([token])
  @@index([status])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}


// ============================================
// MODULE TRACKING EMAIL (SENDGRID WEBHOOKS)
// ============================================

// Événements email reçus via webhooks SendGrid
model EmailEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Référence au destinataire
  recipientId   String
  recipient     EmailRecipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  
  // Référence à la campagne
  campaignId    String
  
  // Type d'événement
  eventType     String    // processed, delivered, open, click, bounce, etc.
  eventDate     DateTime
  
  // Informations du destinataire
  email         String
  
  // Données spécifiques à l'événement
  url           String?   // Pour les clics
  ip            String?
  userAgent     String?
  reason        String?   // Pour les bounces
  
  // Identifiants SendGrid
  sgEventId     String?
  sgMessageId   String?

  @@index([recipientId])
  @@index([campaignId])
  @@index([eventType])
  @@index([eventDate])
  @@index([email])
}



// ============================================
// GESTION DES CONSENTEMENTS RGPD
// ============================================

model ConsentHistory {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  // Relation avec le donateur
  donorId     String
  donor       Donor    @relation(fields: [donorId], references: [id], onDelete: Cascade)
  
  // Type de changement
  consentType String   // "update", "opt_in", "opt_out", "initial"
  
  // Valeurs avant/après (JSON)
  previousValue String?
  newValue      String
  
  // Source du changement
  source      String   // "admin", "preference_center", "email_link", "import", "api"
  reason      String?  // Raison du changement (optionnel)
  
  // Informations de traçabilité
  ipAddress   String?
  userAgent   String?
  userId      Int?     // ID de l'admin qui a fait le changement (si applicable)
  
  @@index([donorId])
  @@index([createdAt])
}


// ============================================
// MODULE NOTIFICATIONS
// ============================================

model Notification {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Type et catégorie
  type        NotificationType
  category    NotificationCategory
  priority    NotificationPriority @default(MEDIUM)
  
  // Contenu
  title       String
  message     String
  actionUrl   String?
  actionLabel String?
  
  // Données additionnelles (JSON)
  metadata    String?  // JSON avec données contextuelles
  
  // Entités liées (optionnel)
  donorId     String?
  campaignId  String?
  donationId  String?
  formId      String?
  
  // Statut
  isRead      Boolean  @default(false)
  readAt      DateTime?
  isDismissed Boolean  @default(false)
  dismissedAt DateTime?
  
  // Utilisateur destinataire (null = tous les admins)
  userId      Int?
  
  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([category])
  @@index([createdAt])
}

enum NotificationType {
  // Dons
  NEW_DONATION           // Nouveau don reçu
  MAJOR_DONATION         // Don majeur (au-dessus d'un seuil)
  RECURRING_CANCELLED    // Don récurrent annulé
  RECURRING_FAILED       // Échec de prélèvement récurrent
  
  // Donateurs
  NEW_DONOR              // Nouveau donateur
  DONOR_MILESTONE        // Donateur atteint un jalon
  DONOR_INACTIVE         // Donateur inactif depuis X mois
  
  // Campagnes
  CAMPAIGN_GOAL_50       // Campagne à 50% de l'objectif
  CAMPAIGN_GOAL_75       // Campagne à 75% de l'objectif
  CAMPAIGN_GOAL_100      // Campagne objectif atteint
  CAMPAIGN_ENDING        // Campagne se termine bientôt
  CAMPAIGN_ENDED         // Campagne terminée
  
  // Formulaires
  FORM_SUBMISSION        // Nouvelle soumission de formulaire
  FORM_ERROR             // Erreur sur un formulaire
  
  // Emails
  EMAIL_BOUNCED          // Email rebondi
  EMAIL_CAMPAIGN_SENT    // Campagne email envoyée
  EMAIL_LOW_OPEN_RATE    // Taux d'ouverture faible
  
  // P2P
  P2P_NEW_FUNDRAISER     // Nouveau collecteur P2P
  P2P_GOAL_REACHED       // Collecteur a atteint son objectif
  
  // Système
  SYSTEM_ALERT           // Alerte système
  SYSTEM_INFO            // Information système
}

enum NotificationCategory {
  DONATIONS
  DONORS
  CAMPAIGNS
  FORMS
  EMAILS
  P2P
  SYSTEM
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// Préférences de notification par utilisateur
model NotificationPreference {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  userId      Int      @unique
  
  // Préférences par catégorie (JSON)
  // Format: { "DONATIONS": { "email": true, "inApp": true, "threshold": 1000 }, ... }
  preferences String   @default("{}")
  
  // Seuils personnalisés
  majorDonationThreshold Int @default(1000)
  inactiveDonorDays      Int @default(180)
  
  // Canaux
  emailEnabled    Boolean @default(true)
  inAppEnabled    Boolean @default(true)
  
  @@index([userId])
}


// ============================================
// MODULE SEGMENTATION AVANCÉE
// ============================================

model DonorSegment {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Informations de base
  name        String
  description String?
  color       String   @default("#8B5CF6")
  icon        String?
  
  // Type de segment
  type        SegmentType @default(DYNAMIC)
  
  // Règles de segmentation (JSON)
  // Format: { "operator": "AND", "rules": [{ "field": "totalDonated", "operator": ">=", "value": 1000 }, ...] }
  rules       String?
  
  // Statistiques (mises à jour périodiquement)
  donorCount  Int      @default(0)
  totalValue  Float    @default(0)
  avgDonation Float    @default(0)
  
  // Dernière mise à jour des stats
  lastCalculatedAt DateTime?
  
  // Statut
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false)  // Segments système non modifiables
  
  // Créateur
  createdById Int?
  
  @@index([isActive])
  @@index([type])
  @@index([name])
}

enum SegmentType {
  STATIC    // Liste fixe de donateurs
  DYNAMIC   // Basé sur des règles, mis à jour automatiquement
  SMART     // Basé sur l'IA/ML
}

// Appartenance manuelle à un segment (pour segments statiques)
model DonorSegmentMembership {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  
  donorId     String
  segmentId   String
  
  // Métadonnées
  addedBy     Int?     // ID utilisateur qui a ajouté
  reason      String?  // Raison de l'ajout
  
  @@unique([donorId, segmentId])
  @@index([donorId])
  @@index([segmentId])
}


// ============================================
// MODULE REÇUS FISCAUX
// ============================================

model TaxReceipt {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Numéro de reçu séquentiel (format: YYYY-NNNNNN)
  receiptNumber String  @unique
  year          Int
  sequenceNumber Int
  
  // Informations du don
  donationId    String
  donation      Donation @relation(fields: [donationId], references: [id])
  
  // Informations du donateur (snapshot au moment de l'émission)
  donorId       String
  donor         Donor    @relation(fields: [donorId], references: [id])
  donorName     String
  donorAddress  String?
  donorEmail    String?
  
  // Montant et date
  amount        Float
  donationDate  DateTime
  issueDate     DateTime @default(now())
  
  // Type de reçu
  receiptType   ReceiptType @default(SINGLE)
  country       String      @default("CA") // CA = Canada, FR = France
  
  // Fichier PDF
  pdfUrl        String?
  pdfKey        String?
  
  // Statut
  status        ReceiptStatus @default(GENERATED)
  sentAt        DateTime?
  sentTo        String?
  
  // Annulation
  voidedAt      DateTime?
  voidedBy      Int?
  voidReason    String?
  replacedById  String?
  
  @@index([donorId])
  @@index([donationId])
  @@index([year, sequenceNumber])
  @@index([receiptNumber])
  @@index([status])
}

enum ReceiptType {
  SINGLE      // Reçu pour un don unique
  ANNUAL      // Reçu annuel consolidé
  REPLACEMENT // Reçu de remplacement
}

enum ReceiptStatus {
  GENERATED   // Généré mais pas encore envoyé
  SENT        // Envoyé par email
  DOWNLOADED  // Téléchargé par le donateur
  VOIDED      // Annulé
}

// Paramètres de l'organisation pour les reçus fiscaux
model OrganizationSettings {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Informations légales
  organizationName    String
  legalName           String?
  charityNumber       String?   // Numéro d'organisme de bienfaisance (Canada)
  siret               String?   // Numéro SIRET (France)
  rna                 String?   // Numéro RNA (France)
  
  // Adresse
  address             String?
  address2            String?
  city                String?
  state               String?
  postalCode          String?
  country             String    @default("CA")
  
  // Contact
  phone               String?
  email               String?
  website             String?
  
  // Logo pour les reçus
  logoUrl             String?
  
  // Signature autorisée
  authorizedSignatory String?
  signatureUrl        String?
  
  // Paramètres des reçus
  receiptPrefix       String    @default("")  // Préfixe optionnel pour les numéros
  autoSendReceipts    Boolean   @default(true)
  receiptEmailSubject String?
  receiptEmailBody    String?
  
  // Seuil minimum pour émettre un reçu (certains pays ont un minimum)
  minimumReceiptAmount Float    @default(0)
  
  @@index([charityNumber])
}


// ==================== AUTOMATISATIONS ====================

enum AutomationStatus {
  ACTIVE
  PAUSED
  DRAFT
  ARCHIVED
}

enum TriggerType {
  NEW_DONOR
  POST_DONATION
  DONATION_ANNIVERSARY
  DONOR_BIRTHDAY
  INACTIVE_DONOR
  CAMPAIGN_GOAL_REACHED
  RECURRING_CANCELLED
  UPGRADE_OPPORTUNITY
  MANUAL
  SCHEDULED
}

enum ActionType {
  SEND_EMAIL
  SEND_SMS
  CREATE_TASK
  ADD_TAG
  REMOVE_TAG
  UPDATE_SEGMENT
  NOTIFY_TEAM
  WAIT
  CONDITION
}

model Automation {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  status      AutomationStatus @default(DRAFT)
  
  triggerType TriggerType
  triggerConfig Json?
  
  actions     AutomationStep[]
  
  totalExecutions Int @default(0)
  successfulExecutions Int @default(0)
  failedExecutions Int @default(0)
  lastExecutedAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  
  executions  AutomationExecution[]
  
  @@index([status])
  @@index([triggerType])
}

model AutomationStep {
  id           String   @id @default(cuid())
  automationId String
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  
  order        Int
  actionType   ActionType
  config       Json
  
  conditionField String?
  conditionOperator String?
  conditionValue String?
  
  parentActionId String?
  parentAction   AutomationStep? @relation("ActionChildren", fields: [parentActionId], references: [id])
  childActions   AutomationStep[] @relation("ActionChildren")
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([automationId])
  @@index([parentActionId])
}

model AutomationExecution {
  id           String   @id @default(cuid())
  automationId String
  automation   Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  
  donorId      String?
  donationId   String?
  campaignId   String?
  
  status       String   @default("PENDING")
  startedAt    DateTime @default(now())
  completedAt  DateTime?
  
  results      Json?
  error        String?  @db.Text
  
  actionsExecuted Int @default(0)
  currentActionOrder Int @default(0)
  
  scheduledFor DateTime?
  
  @@index([automationId])
  @@index([donorId])
  @@index([status])
  @@index([scheduledFor])
}
