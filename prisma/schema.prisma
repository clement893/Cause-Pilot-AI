generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

// ============================================
// AUTHENTIFICATION & UTILISATEURS
// ============================================

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  createdDonors  Donor[]    @relation("CreatedBy")
  updatedDonors  Donor[]    @relation("UpdatedBy")
  donations      Donation[] @relation("RecordedBy")
}

enum UserRole {
  ADMIN
  MANAGER
  ANALYST
  VIEWER
  USER
}

// ============================================
// MODULE BASE DONATEURS
// ============================================

model Donor {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations personnelles
  firstName   String
  lastName    String
  email       String?  @unique
  phone       String?
  mobile      String?
  dateOfBirth DateTime?

  // Adresse
  address     String?
  address2    String?
  city        String?
  state       String?
  postalCode  String?
  country     String?  @default("Canada")

  // Données professionnelles
  profession  String?
  employer    String?
  jobTitle    String?
  industry    String?

  // Statut et classification
  status      DonorStatus @default(ACTIVE)
  donorType   DonorType   @default(INDIVIDUAL)
  segment     String?
  tags        String[]

  // Métriques calculées (dénormalisées pour performance)
  totalDonations    Float    @default(0)
  donationCount     Int      @default(0)
  averageDonation   Float    @default(0)
  highestDonation   Float    @default(0)
  lastDonationDate  DateTime?
  firstDonationDate DateTime?

  // Notes et commentaires
  notes       String?
  source      String?  // Comment le donateur a été acquis

  // Conformité RGPD/PIPEDA
  consentEmail     Boolean @default(false)
  consentPhone     Boolean @default(false)
  consentMail      Boolean @default(false)
  consentDate      DateTime?
  optOutDate       DateTime?

  // Audit
  createdById Int?
  createdBy   User? @relation("CreatedBy", fields: [createdById], references: [id])
  updatedById Int?
  updatedBy   User? @relation("UpdatedBy", fields: [updatedById], references: [id])

  // Relations
  donations       Donation[]
  preferences     DonorPreference?
  customFields    DonorCustomField[]
  communications  Communication[]
  submissions     DonationSubmission[]

  @@index([email])
  @@index([lastName, firstName])
  @@index([status])
  @@index([segment])
  @@index([createdAt])
  @@index([totalDonations])
}

enum DonorStatus {
  ACTIVE
  INACTIVE
  LAPSED
  DECEASED
  DO_NOT_CONTACT
  PENDING
}

enum DonorType {
  INDIVIDUAL
  CORPORATE
  FOUNDATION
  GOVERNMENT
  ANONYMOUS
}

// ============================================
// HISTORIQUE DES DONS
// ============================================

model Donation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations du don
  amount        Float
  currency      String    @default("CAD")
  donationDate  DateTime
  paymentMethod PaymentMethod
  status        DonationStatus @default(COMPLETED)

  // Référence
  transactionId   String?   @unique
  receiptNumber   String?
  receiptSentAt   DateTime?

  // Campagne associée
  campaignId    String?
  campaignName  String?

  // Type de don
  donationType  DonationType @default(ONE_TIME)
  isRecurring   Boolean      @default(false)
  recurringId   String?

  // Don dédié (in memoriam, en l'honneur de)
  dedicationType  DedicationType?
  dedicateeName   String?
  dedicateeEmail  String?
  notifyDedicatee Boolean @default(false)

  // Notes
  notes         String?
  isAnonymous   Boolean @default(false)

  // Relations
  donorId     String
  donor       Donor  @relation(fields: [donorId], references: [id], onDelete: Cascade)
  recordedById Int?
  recordedBy   User?  @relation("RecordedBy", fields: [recordedById], references: [id])

  @@index([donorId])
  @@index([donationDate])
  @@index([campaignId])
  @@index([status])
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT
  BANK_TRANSFER
  CHECK
  CASH
  PAYPAL
  OTHER
}

enum DonationStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum DonationType {
  ONE_TIME
  MONTHLY
  QUARTERLY
  ANNUAL
  PLEDGE
}

enum DedicationType {
  IN_MEMORY
  IN_HONOR
  TRIBUTE
}

// ============================================
// PRÉFÉRENCES DONATEUR
// ============================================

model DonorPreference {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Canaux de communication préférés
  preferredChannel    CommunicationChannel @default(EMAIL)
  preferredFrequency  CommunicationFrequency @default(MONTHLY)
  preferredLanguage   String @default("fr")

  // Causes d'intérêt
  causesOfInterest    String[]

  // Préférences de don
  preferredAmount     Float?
  preferredPaymentMethod PaymentMethod?

  // Dates importantes
  birthday            DateTime?
  anniversary         DateTime?

  // Relation
  donorId String @unique
  donor   Donor  @relation(fields: [donorId], references: [id], onDelete: Cascade)
}

enum CommunicationChannel {
  EMAIL
  PHONE
  SMS
  MAIL
  SOCIAL_MEDIA
}

enum CommunicationFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  NEVER
}

// ============================================
// CHAMPS PERSONNALISÉS
// ============================================

model CustomFieldDefinition {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String   @unique
  label       String
  fieldType   FieldType
  options     String[] // Pour les champs SELECT/MULTISELECT
  isRequired  Boolean  @default(false)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  // Valeurs
  values DonorCustomField[]
}

model DonorCustomField {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  value     String

  // Relations
  donorId   String
  donor     Donor @relation(fields: [donorId], references: [id], onDelete: Cascade)
  fieldId   String
  field     CustomFieldDefinition @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@unique([donorId, fieldId])
}

enum FieldType {
  TEXT
  NUMBER
  DATE
  BOOLEAN
  SELECT
  MULTISELECT
  URL
  EMAIL
  PHONE
}

// ============================================
// COMMUNICATIONS
// ============================================

model Communication {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  type      CommunicationType
  channel   CommunicationChannel
  subject   String?
  content   String?
  sentAt    DateTime?
  status    CommunicationStatus @default(PENDING)

  // Métriques
  openedAt    DateTime?
  clickedAt   DateTime?
  bouncedAt   DateTime?

  // Relation
  donorId String
  donor   Donor  @relation(fields: [donorId], references: [id], onDelete: Cascade)

  @@index([donorId])
  @@index([sentAt])
  @@index([type])
}

enum CommunicationType {
  THANK_YOU
  RECEIPT
  NEWSLETTER
  APPEAL
  EVENT_INVITATION
  SURVEY
  REMINDER
  OTHER
}

enum CommunicationStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}


// ============================================
// MODULE FORMULAIRES DON
// ============================================

model DonationForm {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations générales
  name          String
  slug          String   @unique
  description   String?
  formType      FormType @default(ONE_TIME)
  status        FormStatus @default(DRAFT)

  // Configuration des montants
  suggestedAmounts    Int[]    @default([25, 50, 100, 250, 500])
  minimumAmount       Float    @default(5)
  maximumAmount       Float?
  allowCustomAmount   Boolean  @default(true)
  defaultAmount       Float?

  // Configuration récurrence (pour dons récurrents)
  recurringOptions    RecurringFrequency[] @default([MONTHLY])
  defaultRecurring    RecurringFrequency?

  // Personnalisation visuelle
  primaryColor        String   @default("#6366f1")
  secondaryColor      String   @default("#8b5cf6")
  logoUrl             String?
  bannerUrl           String?
  thankYouMessage     String?
  thankYouRedirectUrl String?

  // Configuration des champs
  collectPhone        Boolean  @default(false)
  collectAddress      Boolean  @default(false)
  collectEmployer     Boolean  @default(false)
  collectComment      Boolean  @default(true)
  collectDedication   Boolean  @default(false)
  allowAnonymous      Boolean  @default(true)

  // SEO et partage
  metaTitle           String?
  metaDescription     String?
  ogImage             String?

  // Campagne associée
  campaignId          String?
  campaignName        String?

  // Statistiques (dénormalisées)
  totalCollected      Float    @default(0)
  donationCount       Int      @default(0)
  averageDonation     Float    @default(0)

  // Dates de validité
  startDate           DateTime?
  endDate             DateTime?
  goalAmount          Float?

  // Relations
  fields              FormField[]
  submissions         DonationSubmission[]

  @@index([slug])
  @@index([status])
  @@index([formType])
  @@index([createdAt])
}

enum FormType {
  ONE_TIME        // Don unique
  RECURRING       // Don récurrent
  TICKETING       // Billetterie événement
  IN_MEMORIAM     // Don in memoriam
  PEER_TO_PEER    // Collecte P2P
  PLEDGE          // Promesse de don
}

enum FormStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  SCHEDULED
}

enum RecurringFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model FormField {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Configuration du champ
  name          String
  label         String
  fieldType     FormFieldType
  placeholder   String?
  helpText      String?
  defaultValue  String?
  options       String[]  // Pour SELECT/RADIO/CHECKBOX
  
  // Validation
  isRequired    Boolean   @default(false)
  minLength     Int?
  maxLength     Int?
  pattern       String?   // Regex pour validation
  
  // Affichage
  sortOrder     Int       @default(0)
  isVisible     Boolean   @default(true)
  width         FieldWidth @default(FULL)
  
  // Logique conditionnelle
  showIf        String?   // JSON condition

  // Relation
  formId        String
  form          DonationForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([sortOrder])
}

enum FormFieldType {
  TEXT
  EMAIL
  PHONE
  NUMBER
  TEXTAREA
  SELECT
  RADIO
  CHECKBOX
  DATE
  HIDDEN
}

enum FieldWidth {
  FULL
  HALF
  THIRD
}

model DonationSubmission {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations du don
  amount            Float
  currency          String    @default("CAD")
  paymentMethod     PaymentMethod?
  paymentStatus     PaymentStatus @default(PENDING)
  
  // Référence paiement
  stripePaymentId   String?
  stripeCustomerId  String?
  transactionId     String?   @unique

  // Informations donateur
  email             String
  firstName         String
  lastName          String
  phone             String?
  address           String?
  city              String?
  state             String?
  postalCode        String?
  country           String?   @default("Canada")
  
  // Employeur (pour matching gifts)
  employer          String?
  
  // Don récurrent
  isRecurring       Boolean   @default(false)
  recurringFrequency RecurringFrequency?
  nextPaymentDate   DateTime?
  recurringStatus   RecurringStatus?

  // Dédicace (in memoriam)
  dedicationType    DedicationType?
  dedicateeName     String?
  dedicateeEmail    String?
  dedicateeMessage  String?
  notifyDedicatee   Boolean   @default(false)

  // Options
  isAnonymous       Boolean   @default(false)
  comment           String?
  
  // Consentements
  consentEmail      Boolean   @default(false)
  consentNewsletter Boolean   @default(false)
  
  // Données personnalisées (JSON)
  customFields      String?   // JSON des champs personnalisés
  
  // Reçu fiscal
  receiptNumber     String?
  receiptSentAt     DateTime?
  
  // Tracking
  source            String?   // UTM source
  medium            String?   // UTM medium
  campaign          String?   // UTM campaign
  referrer          String?
  ipAddress         String?
  userAgent         String?

  // Relations
  formId            String
  form              DonationForm @relation(fields: [formId], references: [id])
  donorId           String?
  donor             Donor?    @relation(fields: [donorId], references: [id])

  @@index([formId])
  @@index([donorId])
  @@index([email])
  @@index([createdAt])
  @@index([paymentStatus])
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum RecurringStatus {
  ACTIVE
  PAUSED
  CANCELLED
  FAILED
  COMPLETED
}

// Ajout de la relation dans Donor
// (déjà géré par la relation DonationSubmission.donor)


// ============================================
// MODULE GESTION CAMPAGNES
// ============================================

model Campaign {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations générales
  name          String
  slug          String   @unique
  description   String?
  shortDescription String?
  
  // Type et statut
  campaignType  CampaignType @default(FUNDRAISING)
  status        CampaignStatus @default(DRAFT)
  priority      CampaignPriority @default(MEDIUM)

  // Dates
  startDate     DateTime?
  endDate       DateTime?
  launchDate    DateTime?

  // Objectifs financiers
  goalAmount    Float?
  minimumGoal   Float?
  stretchGoal   Float?

  // Statistiques (dénormalisées)
  totalRaised       Float    @default(0)
  donationCount     Int      @default(0)
  donorCount        Int      @default(0)
  averageDonation   Float    @default(0)
  largestDonation   Float    @default(0)
  conversionRate    Float    @default(0)

  // Personnalisation visuelle
  primaryColor      String   @default("#6366f1")
  secondaryColor    String   @default("#8b5cf6")
  logoUrl           String?
  bannerUrl         String?
  thumbnailUrl      String?

  // Contenu
  thankYouMessage   String?
  impactStatement   String?

  // SEO
  metaTitle         String?
  metaDescription   String?
  ogImage           String?

  // Configuration
  isPublic          Boolean  @default(true)
  allowP2P          Boolean  @default(false)
  enableMatching    Boolean  @default(false)
  matchingRatio     Float?   // Ex: 2.0 = 2:1 matching
  matchingCap       Float?

  // Catégorie/Tags
  category          String?
  tags              String[]

  // Relations
  milestones        CampaignMilestone[]
  donors            CampaignDonor[]
  forms             CampaignForm[]
  updates           CampaignUpdate[]
  team              CampaignTeamMember[]

  @@index([slug])
  @@index([status])
  @@index([campaignType])
  @@index([startDate])
  @@index([endDate])
}

enum CampaignType {
  FUNDRAISING       // Collecte générale
  ANNUAL_FUND       // Campagne annuelle
  CAPITAL           // Campagne de capital
  EMERGENCY         // Urgence/Crise
  EVENT             // Événement
  PEER_TO_PEER      // P2P
  CROWDFUNDING      // Financement participatif
  MATCHING          // Campagne avec matching
  PLANNED_GIVING    // Dons planifiés
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
  ARCHIVED
}

enum CampaignPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Jalons de campagne
model CampaignMilestone {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations
  title         String
  description   String?
  targetAmount  Float?
  targetDate    DateTime?
  
  // Statut
  isCompleted   Boolean   @default(false)
  completedAt   DateTime?
  actualAmount  Float?

  // Affichage
  sortOrder     Int       @default(0)
  icon          String?
  color         String?

  // Relation
  campaignId    String
  campaign      Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([sortOrder])
}

// Relation Campagne-Donateur
model CampaignDonor {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Montants
  totalDonated      Float    @default(0)
  donationCount     Int      @default(0)
  firstDonationDate DateTime?
  lastDonationDate  DateTime?
  largestDonation   Float    @default(0)

  // Statut dans la campagne
  donorLevel        DonorLevel @default(SUPPORTER)
  isRecurring       Boolean    @default(false)
  isMajorDonor      Boolean    @default(false)

  // Notes spécifiques à la campagne
  notes             String?

  // Relations
  campaignId        String
  campaign          Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  donorId           String

  @@unique([campaignId, donorId])
  @@index([campaignId])
  @@index([donorId])
  @@index([totalDonated])
}

enum DonorLevel {
  SUPPORTER
  CONTRIBUTOR
  PATRON
  BENEFACTOR
  CHAMPION
  VISIONARY
}

// Formulaires associés à une campagne
model CampaignForm {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Relations
  campaignId    String
  campaign      Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  formId        String

  // Configuration
  isPrimary     Boolean  @default(false)

  @@unique([campaignId, formId])
  @@index([campaignId])
}

// Mises à jour de campagne
model CampaignUpdate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Contenu
  title         String
  content       String
  imageUrl      String?
  videoUrl      String?

  // Publication
  isPublished   Boolean   @default(false)
  publishedAt   DateTime?

  // Statistiques
  viewCount     Int       @default(0)
  shareCount    Int       @default(0)

  // Relation
  campaignId    String
  campaign      Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([publishedAt])
}

// Équipe de campagne
model CampaignTeamMember {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Informations
  name          String
  role          String?
  email         String?
  phone         String?
  photoUrl      String?
  bio           String?

  // Objectifs personnels (pour P2P)
  personalGoal      Float?
  totalRaised       Float    @default(0)
  donorCount        Int      @default(0)

  // Affichage
  sortOrder     Int       @default(0)
  isVisible     Boolean   @default(true)

  // Relation
  campaignId    String
  campaign      Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
}


// ============================================
// MODULE MARKETING AUTOMATION
// ============================================

// Templates d'emails réutilisables
model EmailTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations générales
  name          String
  description   String?
  category      EmailCategory @default(GENERAL)
  
  // Contenu
  subject       String
  preheader     String?       // Texte de prévisualisation
  htmlContent   String        @db.Text
  textContent   String?       @db.Text  // Version texte brut
  
  // Variables disponibles
  variables     String[]      // Ex: ["firstName", "lastName", "donationAmount"]
  
  // Design
  primaryColor  String        @default("#6366f1")
  logoUrl       String?
  footerText    String?
  
  // Statut
  isActive      Boolean       @default(true)
  isDefault     Boolean       @default(false)
  
  // Relations
  campaigns     EmailCampaign[]

  @@index([category])
  @@index([isActive])
}

enum EmailCategory {
  GENERAL
  THANK_YOU
  RECEIPT
  NEWSLETTER
  APPEAL
  EVENT
  REMINDER
  WELCOME
  BIRTHDAY
  ANNIVERSARY
  REACTIVATION
}

// Campagnes email
model EmailCampaign {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations générales
  name          String
  description   String?
  campaignType  EmailCampaignType @default(ONE_TIME)
  status        EmailCampaignStatus @default(DRAFT)
  
  // Contenu (peut surcharger le template)
  subject       String?
  preheader     String?
  htmlContent   String?       @db.Text
  
  // Segmentation des destinataires
  segmentRules  Json?         // Règles de segmentation JSON
  tags          String[]      // Tags pour filtrer les donateurs
  segments      String[]      // Segments de donateurs
  
  // Planification
  scheduledAt   DateTime?
  sentAt        DateTime?
  completedAt   DateTime?
  
  // Configuration
  fromName      String        @default("Nucleus Cause")
  fromEmail     String        @default("noreply@nucleuscause.com")
  replyTo       String?
  
  // A/B Testing
  isABTest      Boolean       @default(false)
  variantA      Json?         // Configuration variante A
  variantB      Json?         // Configuration variante B
  winningVariant String?
  
  // Statistiques
  totalRecipients   Int       @default(0)
  sentCount         Int       @default(0)
  deliveredCount    Int       @default(0)
  openCount         Int       @default(0)
  clickCount        Int       @default(0)
  bounceCount       Int       @default(0)
  unsubscribeCount  Int       @default(0)
  complaintCount    Int       @default(0)
  
  // Métriques calculées
  openRate          Float     @default(0)
  clickRate         Float     @default(0)
  bounceRate        Float     @default(0)
  
  // Relations
  templateId    String?
  template      EmailTemplate? @relation(fields: [templateId], references: [id])
  recipients    EmailRecipient[]
  automationId  String?
  automation    AutomationRule? @relation(fields: [automationId], references: [id])

  @@index([status])
  @@index([campaignType])
  @@index([scheduledAt])
  @@index([sentAt])
}

enum EmailCampaignType {
  ONE_TIME      // Envoi unique
  RECURRING     // Envoi récurrent
  AUTOMATED     // Déclenché par automation
  TRANSACTIONAL // Email transactionnel
}

enum EmailCampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
  FAILED
}

// Destinataires d'une campagne email
model EmailRecipient {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations du destinataire
  email         String
  firstName     String?
  lastName      String?
  
  // Statut d'envoi
  status        EmailRecipientStatus @default(PENDING)
  sentAt        DateTime?
  deliveredAt   DateTime?
  
  // Engagement
  openedAt      DateTime?
  openCount     Int       @default(0)
  clickedAt     DateTime?
  clickCount    Int       @default(0)
  clickedLinks  String[]
  
  // Problèmes
  bouncedAt     DateTime?
  bounceType    BounceType?
  bounceReason  String?
  unsubscribedAt DateTime?
  complainedAt  DateTime?
  
  // Variante A/B
  variant       String?   // "A" ou "B"
  
  // Relation avec donateur (optionnel)
  donorId       String?
  
  // Relation
  campaignId    String
  campaign      EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, email])
  @@index([campaignId])
  @@index([status])
  @@index([email])
}

enum EmailRecipientStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  UNSUBSCRIBED
  COMPLAINED
  FAILED
}

enum BounceType {
  HARD
  SOFT
  TRANSIENT
}

// Règles d'automatisation
model AutomationRule {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations générales
  name          String
  description   String?
  isActive      Boolean       @default(false)
  
  // Déclencheur
  triggerType   AutomationTrigger
  triggerConfig Json?         // Configuration spécifique au trigger
  
  // Conditions
  conditions    Json?         // Conditions additionnelles
  
  // Actions
  actionType    AutomationAction
  actionConfig  Json?         // Configuration de l'action
  
  // Délai
  delayMinutes  Int           @default(0)
  delayType     DelayType     @default(IMMEDIATE)
  
  // Limites
  maxExecutions Int?          // Limite d'exécutions par donateur
  cooldownHours Int?          // Délai entre exécutions
  
  // Statistiques
  executionCount    Int       @default(0)
  lastExecutedAt    DateTime?
  successCount      Int       @default(0)
  failureCount      Int       @default(0)
  
  // Relations
  campaigns     EmailCampaign[]

  @@index([triggerType])
  @@index([isActive])
}

enum AutomationTrigger {
  // Événements donateur
  NEW_DONOR           // Nouveau donateur créé
  FIRST_DONATION      // Premier don
  DONATION_RECEIVED   // Don reçu
  RECURRING_STARTED   // Début don récurrent
  RECURRING_CANCELLED // Annulation don récurrent
  
  // Anniversaires
  BIRTHDAY            // Anniversaire du donateur
  DONATION_ANNIVERSARY // Anniversaire du premier don
  MEMBERSHIP_ANNIVERSARY // Anniversaire d'adhésion
  
  // Engagement
  INACTIVE_30_DAYS    // Inactif depuis 30 jours
  INACTIVE_90_DAYS    // Inactif depuis 90 jours
  INACTIVE_365_DAYS   // Inactif depuis 1 an
  
  // Formulaires
  FORM_SUBMITTED      // Formulaire soumis
  FORM_ABANDONED      // Formulaire abandonné
  
  // Campagnes
  CAMPAIGN_STARTED    // Campagne démarrée
  CAMPAIGN_ENDING     // Campagne se termine bientôt
  CAMPAIGN_GOAL_REACHED // Objectif atteint
  
  // Manuel
  MANUAL              // Déclenché manuellement
  SCHEDULED           // Planifié (date/heure)
}

enum AutomationAction {
  SEND_EMAIL          // Envoyer un email
  SEND_SMS            // Envoyer un SMS
  ADD_TAG             // Ajouter un tag
  REMOVE_TAG          // Retirer un tag
  UPDATE_SEGMENT      // Mettre à jour le segment
  CREATE_TASK         // Créer une tâche
  NOTIFY_TEAM         // Notifier l'équipe
  WEBHOOK             // Appeler un webhook
}

enum DelayType {
  IMMEDIATE           // Immédiat
  MINUTES             // Après X minutes
  HOURS               // Après X heures
  DAYS                // Après X jours
  SPECIFIC_TIME       // À une heure précise
}

// Journal des exécutions d'automatisation
model AutomationLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // Référence à la règle
  automationId  String
  automationName String
  
  // Donateur concerné
  donorId       String?
  donorEmail    String?
  
  // Résultat
  status        AutomationLogStatus
  errorMessage  String?
  
  // Détails
  triggerData   Json?         // Données du déclencheur
  actionResult  Json?         // Résultat de l'action

  @@index([automationId])
  @@index([donorId])
  @@index([createdAt])
  @@index([status])
}

enum AutomationLogStatus {
  SUCCESS
  FAILED
  SKIPPED
  PENDING
}

// Listes de diffusion
model MailingList {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations
  name          String
  description   String?
  
  // Configuration
  isPublic      Boolean       @default(false)  // Visible pour inscription
  isDoubleOptIn Boolean       @default(true)   // Double opt-in requis
  
  // Statistiques
  subscriberCount   Int       @default(0)
  activeCount       Int       @default(0)
  
  // Relations
  subscribers   MailingListSubscriber[]

  @@index([isPublic])
}

model MailingListSubscriber {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informations
  email         String
  firstName     String?
  lastName      String?
  
  // Statut
  status        SubscriberStatus @default(PENDING)
  confirmedAt   DateTime?
  unsubscribedAt DateTime?
  
  // Source
  source        String?       // Comment ils se sont inscrits
  
  // Relation avec donateur
  donorId       String?
  
  // Relation
  listId        String
  list          MailingList @relation(fields: [listId], references: [id], onDelete: Cascade)

  @@unique([listId, email])
  @@index([listId])
  @@index([email])
  @@index([status])
}

enum SubscriberStatus {
  PENDING       // En attente de confirmation
  ACTIVE        // Actif
  UNSUBSCRIBED  // Désabonné
  BOUNCED       // Email invalide
  COMPLAINED    // A signalé comme spam
}
