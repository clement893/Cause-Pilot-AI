/**  * Gestionnaire de connexions Prisma multiples pour isolation par organisation  * Permet d'avoir une base de donnÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âes sÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚ÂparÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âe par organisation pour une sÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚ÂcuritÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Â maximale  */  import { PrismaClient } from "@prisma/client";  // Cache des instances Prisma par organisation const prismaClients = new Map<string, PrismaClient>();  // Instance par dÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âfaut (pour la base principale qui contient les organisations) const globalForPrisma = globalThis as unknown as {   defaultPrisma: PrismaClient | undefined; };  // Instance Prisma pour la base principale (mÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚ÂtadonnÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âes des organisations) export const defaultPrisma =   globalForPrisma.defaultPrisma ??   new PrismaClient({     log: process.env.NODE_ENV === "development" ? ["error", "warn"] : ["error"],     datasources: {       db: {         url: process.env.DATABASE_URL,       },     },   });  if (process.env.NODE_ENV !== "production") {   globalForPrisma.defaultPrisma = defaultPrisma; }  /**  * RÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚ÂcupÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒâ€šÃ‚Â¿re l'URL de la base de donnÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âes pour une organisation  * Si l'organisation a une databaseUrl configurÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âe, l'utilise  * Sinon, utilise la DATABASE_URL par dÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âfaut (mode partagÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Â)  */ async function getOrganizationDatabaseUrl(organizationId: string): Promise<string> {   try {     const organization = await defaultPrisma.organization.findUnique({       where: { id: organizationId },       select: { databaseUrl: true },     });      // Si l'organisation a sa propre base de donnÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âes     if (organization?.databaseUrl) {       return organization.databaseUrl;     }      // Sinon, utiliser la base par dÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âfaut (mode partagÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Â)     return process.env.DATABASE_URL || "";   } catch (error) {     console.error(`Error fetching database URL for organization ${organizationId}:`, error);     // Fallback vers la base par dÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âfaut     return process.env.DATABASE_URL || "";   } }  /**  * Obtient ou crÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âe une instance PrismaClient pour une organisation spÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âcifique  */ export async function getPrismaForOrganization(   organizationId: string | null ): Promise<PrismaClient> {   // Si pas d'organisation, utiliser l'instance par dÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âfaut   if (!organizationId) {     return defaultPrisma;   }    // VÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Ârifier si on a dÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚ÂjÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÆ’Ã‚Â¡ une instance en cache   if (prismaClients.has(organizationId)) {     return prismaClients.get(organizationId)!;   }    // RÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚ÂcupÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Ârer l'URL de la base pour cette organisation   const databaseUrl = await getOrganizationDatabaseUrl(organizationId);    // Si c'est la mÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒâ€šÃ‚Â¬me URL que la base par dÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âfaut, rÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âutiliser l'instance   if (databaseUrl === process.env.DATABASE_URL) {     prismaClients.set(organizationId, defaultPrisma);     return defaultPrisma;   }    // CrÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âer une nouvelle instance PrismaClient pour cette organisation   const prisma = new PrismaClient({     log: process.env.NODE_ENV === "development" ? ["error", "warn"] : ["error"],     datasources: {       db: {         url: databaseUrl,       },     },   });    // Mettre en cache   prismaClients.set(organizationId, prisma);    return prisma; }  /**  * Nettoie les connexions Prisma (utile pour les tests ou le redÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âmarrage)  */ export async function disconnectAllPrismaClients(): Promise<void> {   await Promise.all(     Array.from(prismaClients.values()).map((client) => client.$disconnect())   );   await defaultPrisma.$disconnect();   prismaClients.clear(); }  /**  * VÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Ârifie si une organisation utilise une base de donnÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âes dÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚ÂdiÃƒÂ¢Ã¢â‚¬ÂÃ…â€œÃƒÂ¢Ã…â€™Ã‚Âe  */ export async function hasDedicatedDatabase(organizationId: string): Promise<boolean> {   try {     const organization = await defaultPrisma.organization.findUnique({       where: { id: organizationId },       select: { databaseUrl: true },     });     return !!organization?.databaseUrl;   } catch {     return false;   } }